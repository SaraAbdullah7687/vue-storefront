# Builder image
FROM node:16-alpine as builder
ARG NPM_USER
ARG NPM_PASS
ARG NPM_EMAIL
ARG NPM_REGISTRY
ARG LAST_COMMIT
ARG VSF_STORE_URL
ARG VSF_NUXT_APP_HOST
ARG VSF_NUXT_APP_ENV
ARG VSF_NUXT_APP_PORT

ARG VSF_MAGENTO_BASE_URL
ARG VSF_MAGENTO_GRAPHQL_URL
ARG VSF_MAGENTO_EXTERNAL_CHECKOUT_ENABLED
ARG VSF_MAGENTO_EXTERNAL_CHECKOUT_URL
ARG VSF_MAGENTO_EXTERNAL_CHECKOUT_SYNC_PATH

ARG NUXT_IMAGE_PROVIDER
ARG NUXT_IMAGE_PROVIDER_BASE_URL
ARG NUXT_IMAGE_PROVIDER_DOMAIN

ARG VSF_REDIS_ENABLED
ARG VSF_REDIS_HOST
ARG VSF_REDIS_PORT
ARG VSF_REDIS_KEY_PREFIX
ARG VSF_REDIS_CACHE_INVALIDATE_URL
ARG VSF_REDIS_CACHE_INVALIDATE_KEY

ARG VSF_RECAPTCHA_ENABLED
ARG VSF_RECAPTCHA_HIDE_BADGE
ARG VSF_RECAPTCHA_VERSION
ARG VSF_RECAPTCHA_SIZE
ARG VSF_RECAPTCHA_MIN_SCORE
ARG VSF_RECAPTCHA_SITE_KEY
ARG VSF_RECAPTCHA_SECRET_KEY
ARG API_BASE_URL
ARG API_SSR_BASE_URL

ARG VSF_SENTRY_DSN

ENV LAST_COMMIT=${LAST_COMMIT}

ENV VSF_NUXT_APP_HOST=${VSF_NUXT_APP_HOST}
ENV VSF_NUXT_APP_ENV=${VSF_NUXT_APP_ENV}
ENV VSF_NUXT_APP_PORT=${VSF_NUXT_APP_PORT}

ENV VSF_MAGENTO_BASE_URL=${VSF_MAGENTO_BASE_URL}
ENV VSF_MAGENTO_GRAPHQL_URL=${VSF_MAGENTO_GRAPHQL_URL}
ENV VSF_MAGENTO_EXTERNAL_CHECKOUT_ENABLED=${VSF_MAGENTO_EXTERNAL_CHECKOUT_ENABLED}
ENV VSF_MAGENTO_EXTERNAL_CHECKOUT_URL=${VSF_MAGENTO_EXTERNAL_CHECKOUT_URL}
ENV VSF_MAGENTO_EXTERNAL_CHECKOUT_SYNC_PATH=${VSF_MAGENTO_EXTERNAL_CHECKOUT_SYNC_PATH}
ENV VSF_STORE_URL=${VSF_STORE_URL}
ENV NUXT_IMAGE_PROVIDER=${NUXT_IMAGE_PROVIDER}
ENV NUXT_IMAGE_PROVIDER_BASE_URL=${NUXT_IMAGE_PROVIDER_BASE_URL}
ENV NUXT_IMAGE_PROVIDER_DOMAINL=${NUXT_IMAGE_PROVIDER_DOMAINL}
ENV VSF_REDIS_ENABLED=${VSF_REDIS_ENABLED}
ENV VSF_REDIS_HOST=${VSF_REDIS_HOST}
ENV VSF_REDIS_PORT=${VSF_REDIS_PORT}
ENV VSF_REDIS_KEY_PREFIX=${VSF_REDIS_KEY_PREFIX}
ENV VSF_REDIS_CACHE_INVALIDATE_KEY=${VSF_REDIS_CACHE_INVALIDATE_KEY}
ENV VSF_REDIS_CACHE_INVALIDATE_URL=${VSF_REDIS_CACHE_INVALIDATE_URL}
ENV VSF_SENTRY_DSN=${VSF_SENTRY_DSN}
ENV VSF_RECAPTCHA_ENABLED=${VSF_RECAPTCHA_ENABLED}
ENV VSF_RECAPTCHA_HIDE_BADGE=${VSF_RECAPTCHA_HIDE_BADGE}
ENV VSF_RECAPTCHA_VERSION=${VSF_RECAPTCHA_VERSION}
ENV VSF_RECAPTCHA_SIZE=${VSF_RECAPTCHA_SIZE}
ENV VSF_RECAPTCHA_MIN_SCORE=${VSF_RECAPTCHA_MIN_SCORE}
ENV VSF_RECAPTCHA_SITE_KEY=${VSF_RECAPTCHA_SITE_KEY}
ENV VSF_RECAPTCHA_SECRET_KEY=${VSF_RECAPTCHA_SECRET_KEY}
ENV API_BASE_URL=${API_BASE_URL}
ENV API_SSR_BASE_URL=${API_SSR_BASE_URL}

RUN npm install -g npm-cli-login && npm-cli-login

WORKDIR /var/www

COPY . .

RUN mv /var/www/nuxt.config.js /var/www/base.nuxt.config.js \
    && cp .vuestorefrontcloud/docker/storefront/nuxt.config.additional.js /var/www/nuxt.config.js

## Install and build
RUN apk add --no-cache --virtual .gyp \
        python3 \
        make \
        g++

RUN yarn install
RUN yarn build
RUN yarn install --production
RUN find . -type d -name "*test*" -not -path '*/node_modules/*' -exec rm -rf {} +

# Final application image
FROM node:16-alpine

ARG API_BASE_URL
ARG API_SSR_BASE_URL
ARG VSF_MAGENTO_BASE_URL
ARG VSF_MAGENTO_GRAPHQL_URL
ARG NUXT_VERSION=2.15.6

ENV API_BASE_URL=${API_BASE_URL}
ENV API_SSR_BASE_URL=${API_SSR_BASE_URL}
ENV VSF_MAGENTO_BASE_URL=${VSF_MAGENTO_BASE_URL}
ENV VSF_MAGENTO_GRAPHQL_URL=${VSF_MAGENTO_GRAPHQL_URL}
ENV NUXT_VERSION=${NUXT_VERSION}

WORKDIR /var/www

COPY --from=builder /var/www/. .
COPY .vuestorefrontcloud/docker/storefront/vue-storefront.sh /usr/local/bin/

RUN chmod a+x /usr/local/bin/vue-storefront.sh

ENTRYPOINT ["vue-storefront.sh"]
