"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var s=require("fs"),e=require("purgecss"),o=t(e),n=require("webpack-sources"),i=t(require("path"));function r(t,s){const e=i.extname((o=t).includes("?")?o.split("?").slice(0,-1).join(""):o);var o;return s.includes(e)}function a(t,s,e){const o=[];for(const n of Array.from(t.modulesIterable||[])){const t=e(n);t&&s.includes(i.extname(t))&&o.push(t)}return o}const c=[".css",".scss",".styl",".sass",".less"];module.exports=class{constructor(t){this.purgedStats={},this.options=t}apply(t){t.hooks.compilation.tap("PurgeCSS",t=>{this.initializePlugin(t)}),t.hooks.done.tap("PurgeCSS",this.onHooksDone.bind(this))}onHooksDone(t){t.hasErrors()?this.options.verbose&&console.warn("purge-webpack-plugin: pausing due to webpack errors"):this.options.rejected&&(t.purged=this.purgedStats)}getAssetsToPurge(t,s){return t.filter(t=>this.options.only?this.options.only.some(s=>t&&t.name.includes(s)):t&&s.includes(t.name))}initializePlugin(t){t.hooks.additionalAssets.tapPromise("PurgeCSS",()=>{const e="function"==typeof this.options.paths?this.options.paths():this.options.paths;return e.forEach(t=>{if(!s.existsSync(t))throw new Error(`Path ${t} does not exist.`)}),this.runPluginHook(t,e)})}async runPluginHook(t,s){const i=function(t={},s){const e=[];for(const[o,n]of Object.entries(t))r(o,s)&&e.push({name:o,asset:n});return e}(t.assets,[".css"]);for(const r of t.chunks){const{files:u}=r,l=this.getAssetsToPurge(i,u);for(const{name:i,asset:u}of l){const l=s.concat(a(r,this.options.moduleExtensions||[],t=>t.resource)).filter(t=>!c.some(s=>t.endsWith(s))),h={...e.defaultOptions,...this.options,content:l,css:[{raw:u.source()}]};"function"==typeof h.whitelist&&(h.whitelist=h.whitelist()),"function"==typeof h.whitelistPatterns&&(h.whitelistPatterns=h.whitelistPatterns()),"function"==typeof h.whitelistPatternsChildren&&(h.whitelistPatternsChildren=h.whitelistPatternsChildren());const p=(await(new o).purge({content:h.content,css:h.css,defaultExtractor:h.defaultExtractor,extractors:h.extractors,fontFace:h.fontFace,keyframes:h.keyframes,output:h.output,rejected:h.rejected,variables:h.variables,whitelist:h.whitelist,whitelistPatterns:h.whitelistPatterns,whitelistPatternsChildren:h.whitelistPatternsChildren}))[0];p.rejected&&(this.purgedStats[i]=p.rejected),t.assets[i]=new n.ConcatSource(p.css)}}}};
